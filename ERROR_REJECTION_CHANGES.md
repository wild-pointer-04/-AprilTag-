# é‡æŠ•å½±è¯¯å·®æ·˜æ±°åŠŸèƒ½ä¿®æ”¹è¯´æ˜

## ä¿®æ”¹æ¦‚è¿°

ä¿®æ”¹äº† `robust_tilt_checker_node.py`ï¼Œä½¿å…¶èƒ½å¤ŸçœŸæ­£æ·˜æ±°é‡æŠ•å½±è¯¯å·®è¶…è¿‡é˜ˆå€¼çš„å›¾ç‰‡ï¼Œè€Œä¸ä»…ä»…æ˜¯æ‰“å°è­¦å‘Šã€‚

---

## ä¿®æ”¹å‰çš„è¡Œä¸º

### ä»£ç é€»è¾‘
```python
# åªæ˜¯æ‰“å°è­¦å‘Šï¼Œç»§ç»­å¤„ç†
if robust_error > self.max_reprojection_error:
    self.get_logger().warn(f'âš ï¸ é‡æŠ•å½±è¯¯å·®è¶…è¿‡é˜ˆå€¼: {robust_error:.3f}px')
# ç»§ç»­å¾€ä¸‹æ‰§è¡Œ...
result = {'success': True, ...}  # ä»ç„¶æ ‡è®°ä¸ºæˆåŠŸ
self.all_results.append(result)  # ä»ç„¶ä¿å­˜ç»“æœ
```

### å®é™…æ•ˆæœ
- âŒ æ‰€æœ‰æ£€æµ‹åˆ°ç½‘æ ¼çš„å›¾ç‰‡éƒ½è¢«å¤„ç†
- âŒ é«˜è¯¯å·®å›¾ç‰‡ä»ç„¶ä¿å­˜ç»“æœå’Œå›¾åƒ
- âŒ ç»Ÿè®¡ä¸­æ ‡è®°ä¸º `success: True`
- âœ… åªåœ¨æ—¥å¿—ä¸­æ‰“å°è­¦å‘Š

### è¿è¡Œç¤ºä¾‹
```bash
python robust_tilt_checker_node.py --max-error 1.0 --rosbag test.bag --save-images
```

**è¾“å‡º**ï¼š
```
[frame_001] âœ… é‡æŠ•å½±è¯¯å·®æ­£å¸¸: 0.8px
[frame_002] âš ï¸ é‡æŠ•å½±è¯¯å·®è¶…è¿‡é˜ˆå€¼: 3.2px  # è­¦å‘Šä½†ç»§ç»­å¤„ç†
[frame_003] âš ï¸ é‡æŠ•å½±è¯¯å·®è¶…è¿‡é˜ˆå€¼: 5.1px  # è­¦å‘Šä½†ç»§ç»­å¤„ç†
```

**ç»“æœ**ï¼š
- å¤„ç†äº† 3 å¸§
- ä¿å­˜äº† 3 å¼ å›¾ç‰‡
- success_count = 3

---

## ä¿®æ”¹åçš„è¡Œä¸º

### ä»£ç é€»è¾‘
```python
# æ£€æŸ¥è¯¯å·®å¹¶æ·˜æ±°è¶…è¿‡é˜ˆå€¼çš„å¸§
if robust_error > self.max_reprojection_error:
    self.rejected_by_error_count += 1
    self.failure_count += 1
    self.get_logger().error(f'âŒ é‡æŠ•å½±è¯¯å·®è¶…è¿‡é˜ˆå€¼ï¼Œæ·˜æ±°è¯¥å¸§')
    return None  # ç›´æ¥è¿”å›ï¼Œä¸ä¿å­˜ä»»ä½•ç»“æœ
```

### å®é™…æ•ˆæœ
- âœ… åªå¤„ç†è¯¯å·® <= é˜ˆå€¼çš„å›¾ç‰‡
- âœ… é«˜è¯¯å·®å›¾ç‰‡ä¸ä¿å­˜ç»“æœå’Œå›¾åƒ
- âœ… ç»Ÿè®¡ä¸­æ ‡è®°ä¸ºå¤±è´¥
- âœ… æ–°å¢æ·˜æ±°è®¡æ•°å™¨å’Œç»Ÿè®¡

### è¿è¡Œç¤ºä¾‹
```bash
python robust_tilt_checker_node.py --max-error 1.0 --rosbag test.bag --save-images
```

**è¾“å‡º**ï¼š
```
[frame_001] âœ… é‡æŠ•å½±è¯¯å·®æ­£å¸¸: 0.8px
[frame_002] âŒ é‡æŠ•å½±è¯¯å·® 3.2px è¶…è¿‡é˜ˆå€¼ 1.0pxï¼Œæ·˜æ±°è¯¥å¸§
[frame_003] âŒ é‡æŠ•å½±è¯¯å·® 5.1px è¶…è¿‡é˜ˆå€¼ 1.0pxï¼Œæ·˜æ±°è¯¥å¸§
```

**ç»“æœ**ï¼š
- å¤„ç†äº† 3 å¸§
- ä¿å­˜äº† 1 å¼ å›¾ç‰‡ï¼ˆåªæœ‰ frame_001ï¼‰
- success_count = 1
- failure_count = 2
- rejected_by_error_count = 2

---

## è¯¦ç»†ä¿®æ”¹å†…å®¹

### 1. æ–°å¢ç»Ÿè®¡è®¡æ•°å™¨

**ä½ç½®**: `__init__()` æ–¹æ³•

```python
self.rejected_by_error_count = 0  # å› é‡æŠ•å½±è¯¯å·®è¶…è¿‡é˜ˆå€¼è¢«æ·˜æ±°çš„å¸§æ•°
```

### 2. ä¿®æ”¹è¯¯å·®æ£€æŸ¥é€»è¾‘

**ä½ç½®**: `process_frame()` æ–¹æ³•ï¼Œç¬¬ 402-420 è¡Œ

**ä¿®æ”¹å‰**:
```python
if robust_error > 50:
    self.high_error_count += 1
    self.get_logger().warn(f'âš ï¸ é‡æŠ•å½±è¯¯å·®ä»ç„¶è¾ƒé«˜: {robust_error:.3f}px')
elif robust_error > self.max_reprojection_error:
    self.get_logger().warn(f'âš ï¸ é‡æŠ•å½±è¯¯å·®è¶…è¿‡é˜ˆå€¼: {robust_error:.3f}px')
else:
    self.get_logger().info(f'âœ… é‡æŠ•å½±è¯¯å·®æ­£å¸¸: {robust_error:.3f}px')
# ç»§ç»­å¤„ç†...
```

**ä¿®æ”¹å**:
```python
# æ£€æŸ¥é‡æŠ•å½±è¯¯å·®å¹¶æ·˜æ±°è¶…è¿‡é˜ˆå€¼çš„å¸§
if robust_error > self.max_reprojection_error:
    self.rejected_by_error_count += 1
    self.failure_count += 1
    self.get_logger().error(
        f'âŒ é‡æŠ•å½±è¯¯å·® {robust_error:.3f}px è¶…è¿‡é˜ˆå€¼ {self.max_reprojection_error}pxï¼Œæ·˜æ±°è¯¥å¸§'
    )
    self.get_logger().info(
        f'ğŸ“Š ç»Ÿè®¡: æˆåŠŸ={self.success_count}, å¤±è´¥={self.failure_count}, '
        f'å› è¯¯å·®æ·˜æ±°={self.rejected_by_error_count}'
    )
    return None  # ç›´æ¥è¿”å›ï¼Œä¸ä¿å­˜ç»“æœ

# è®°å½•é«˜è¯¯å·®ä½†æœªè¶…è¿‡é˜ˆå€¼çš„æƒ…å†µ
if robust_error > 50:
    self.high_error_count += 1
    self.get_logger().warn(f'âš ï¸ é‡æŠ•å½±è¯¯å·®è¾ƒé«˜: {robust_error:.3f}px (ä½†æœªè¶…è¿‡é˜ˆå€¼)')
else:
    self.get_logger().info(f'âœ… é‡æŠ•å½±è¯¯å·®æ­£å¸¸: {robust_error:.3f}px')
```

### 3. æ›´æ–°ç»Ÿè®¡æ—¥å¿—

**ä½ç½®**: `process_frame()` æ–¹æ³•æœ«å°¾

```python
self.get_logger().info(
    f'ğŸ“Š ç»Ÿè®¡: æˆåŠŸ={self.success_count}, å¤±è´¥={self.failure_count}, '
    f'AprilTagæˆåŠŸ={self.apriltag_success_count}, å› è¯¯å·®æ·˜æ±°={self.rejected_by_error_count}'
)
```

### 4. æ›´æ–° JSON ç»“æœ

**ä½ç½®**: `save_results_to_files()` æ–¹æ³•

```python
'summary': {
    'total_frames': self.frame_count,
    'success_count': self.success_count,
    'failure_count': self.failure_count,
    'rejected_by_error_count': self.rejected_by_error_count,  # æ–°å¢
    'rejection_rate': self.rejected_by_error_count / self.frame_count,  # æ–°å¢
    ...
}
```

### 5. æ›´æ–°ç»Ÿè®¡æŠ¥å‘Š

**ä½ç½®**: `_generate_summary_report()` æ–¹æ³•

```
å¤„ç†ç»Ÿè®¡:
  æ€»å¸§æ•°: 100
  æˆåŠŸæ£€æµ‹: 85
  å¤±è´¥æ£€æµ‹: 15
    - å› é‡æŠ•å½±è¯¯å·®è¶…è¿‡é˜ˆå€¼è¢«æ·˜æ±°: 12  # æ–°å¢
    - å…¶ä»–åŸå› å¤±è´¥: 3                  # æ–°å¢
  æˆåŠŸç‡: 85.00%
  æ·˜æ±°ç‡: 12.00%                       # æ–°å¢

é‡æŠ•å½±è¯¯å·®ç»Ÿè®¡ï¼ˆä»…åŒ…å«é€šè¿‡é˜ˆå€¼çš„å¸§ï¼‰:  # ä¿®æ”¹
  è¯¯å·®é˜ˆå€¼: 1.0 åƒç´                     # æ–°å¢
  é€šè¿‡é˜ˆå€¼çš„å¸§æ•°: 85                    # æ–°å¢
  è¢«æ·˜æ±°çš„å¸§æ•°: 12                      # æ–°å¢
  å¹³å‡è¯¯å·®: 0.654 åƒç´ 
  æœ€å¤§è¯¯å·®: 0.987 åƒç´ 
  æœ€å°è¯¯å·®: 0.123 åƒç´ 
```

---

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: ä¸¥æ ¼æ¨¡å¼ï¼ˆæ·˜æ±°è¯¯å·® > 1.0pxï¼‰

```bash
python robust_tilt_checker_node.py \
    --rosbag rosbags/testbag \
    --image-topic /left/color/image_raw \
    --camera-yaml config/camera_info.yaml \
    --rows 15 --cols 15 \
    --tag-family tagStandard41h12 \
    --tag-size 0.0071 \
    --board-spacing 0.065 \
    --max-error 1.0 \
    --save-images \
    --publish-results
```

**æ•ˆæœ**ï¼š
- åªä¿å­˜è¯¯å·® <= 1.0px çš„å›¾ç‰‡
- é«˜è´¨é‡æ ‡å®šæ•°æ®é›†

### ç¤ºä¾‹ 2: ä¸­ç­‰æ¨¡å¼ï¼ˆæ·˜æ±°è¯¯å·® > 5.0pxï¼‰

```bash
python robust_tilt_checker_node.py \
    --max-error 5.0 \
    --rosbag rosbags/testbag \
    --save-images
```

**æ•ˆæœ**ï¼š
- ä¿ç•™å¤§éƒ¨åˆ†å›¾ç‰‡
- åªæ·˜æ±°æ˜æ˜¾å¼‚å¸¸çš„å¸§

### ç¤ºä¾‹ 3: å®½æ¾æ¨¡å¼ï¼ˆæ·˜æ±°è¯¯å·® > 10.0pxï¼Œé»˜è®¤ï¼‰

```bash
python robust_tilt_checker_node.py \
    --max-error 10.0 \
    --rosbag rosbags/testbag \
    --save-images
```

**æ•ˆæœ**ï¼š
- ä¿ç•™å‡ ä¹æ‰€æœ‰å›¾ç‰‡
- åªæ·˜æ±°æç«¯å¼‚å¸¸çš„å¸§

### ç¤ºä¾‹ 4: ä¸æ·˜æ±°æ¨¡å¼ï¼ˆç”¨äºè°ƒè¯•ï¼‰

```bash
python robust_tilt_checker_node.py \
    --max-error 1000.0 \
    --rosbag rosbags/testbag \
    --save-images
```

**æ•ˆæœ**ï¼š
- ä¸æ·˜æ±°ä»»ä½•å›¾ç‰‡
- ç”¨äºæŸ¥çœ‹æ‰€æœ‰å¸§çš„è¯¯å·®åˆ†å¸ƒ

---

## é¢„æœŸæ•ˆæœå¯¹æ¯”

### åœºæ™¯ï¼š100 å¸§å›¾ç‰‡ï¼Œè¯¯å·®åˆ†å¸ƒå¦‚ä¸‹
- 70 å¸§: è¯¯å·® < 1.0px
- 15 å¸§: è¯¯å·® 1.0-5.0px
- 10 å¸§: è¯¯å·® 5.0-10.0px
- 5 å¸§: è¯¯å·® > 10.0px

### ä½¿ç”¨ `--max-error 1.0`

| æŒ‡æ ‡ | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|------|--------|--------|
| å¤„ç†çš„å¸§æ•° | 100 | 100 |
| ä¿å­˜çš„å›¾ç‰‡ | 100 | 70 |
| success_count | 100 | 70 |
| failure_count | 0 | 30 |
| rejected_by_error_count | - | 30 |
| å¹³å‡è¯¯å·® | 3.2px | 0.6px |

### ä½¿ç”¨ `--max-error 5.0`

| æŒ‡æ ‡ | ä¿®æ”¹å‰ | ä¿®æ”¹å |
|------|--------|--------|
| å¤„ç†çš„å¸§æ•° | 100 | 100 |
| ä¿å­˜çš„å›¾ç‰‡ | 100 | 85 |
| success_count | 100 | 85 |
| failure_count | 0 | 15 |
| rejected_by_error_count | - | 15 |
| å¹³å‡è¯¯å·® | 3.2px | 1.8px |

---

## æ³¨æ„äº‹é¡¹

1. **é˜ˆå€¼è®¾ç½®å»ºè®®**
   - é«˜ç²¾åº¦æ ‡å®š: `--max-error 1.0` (ä¸¥æ ¼)
   - ä¸€èˆ¬åº”ç”¨: `--max-error 5.0` (æ¨è)
   - å®½æ¾æ¨¡å¼: `--max-error 10.0` (é»˜è®¤)

2. **æ·˜æ±°ç‡ç›‘æ§**
   - å¦‚æœæ·˜æ±°ç‡ > 50%ï¼Œè¯´æ˜é˜ˆå€¼å¯èƒ½è®¾ç½®è¿‡ä¸¥
   - å¦‚æœæ·˜æ±°ç‡ < 5%ï¼Œè¯´æ˜é˜ˆå€¼å¯èƒ½è®¾ç½®è¿‡æ¾
   - å»ºè®®æ·˜æ±°ç‡åœ¨ 10-30% ä¹‹é—´

3. **è°ƒè¯•å»ºè®®**
   - é¦–æ¬¡è¿è¡Œä½¿ç”¨å¤§é˜ˆå€¼ï¼ˆå¦‚ 100.0ï¼‰æŸ¥çœ‹è¯¯å·®åˆ†å¸ƒ
   - æ ¹æ®è¯¯å·®åˆ†å¸ƒè®¾ç½®åˆé€‚çš„é˜ˆå€¼
   - æŸ¥çœ‹ç»Ÿè®¡æŠ¥å‘Šä¸­çš„è¯¯å·®ç»Ÿè®¡

4. **è¾“å‡ºæ–‡ä»¶**
   - `robust_results.json`: åªåŒ…å«é€šè¿‡é˜ˆå€¼çš„å¸§
   - `detailed_results.csv`: åªåŒ…å«é€šè¿‡é˜ˆå€¼çš„å¸§
   - `summary_report.txt`: åŒ…å«æ·˜æ±°ç»Ÿè®¡
   - `images/`: åªä¿å­˜é€šè¿‡é˜ˆå€¼çš„å›¾ç‰‡

---

## éªŒè¯ä¿®æ”¹

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
python test_error_rejection.py
```

é¢„æœŸè¾“å‡ºï¼š
```
æµ‹è¯•åœºæ™¯:
å¸§ID            è¯¯å·®(px)     é˜ˆå€¼(px)     é¢„æœŸç»“æœ   å®é™…ç»“æœ   
--------------------------------------------------------------------------------
frame_001       0.50         1.00         é€šè¿‡       é€šè¿‡       âœ…
frame_002       0.90         1.00         é€šè¿‡       é€šè¿‡       âœ…
frame_003       1.50         1.00         æ·˜æ±°       æ·˜æ±°       âœ…
frame_004       5.00         1.00         æ·˜æ±°       æ·˜æ±°       âœ…
frame_005       0.30         1.00         é€šè¿‡       é€šè¿‡       âœ…
frame_006       10.00        1.00         æ·˜æ±°       æ·˜æ±°       âœ…
```

---

## æ€»ç»“

âœ… **ä¿®æ”¹å®Œæˆ**ï¼šç¨‹åºç°åœ¨ä¼šçœŸæ­£æ·˜æ±°é‡æŠ•å½±è¯¯å·®è¶…è¿‡é˜ˆå€¼çš„å›¾ç‰‡

âœ… **ç»Ÿè®¡å®Œå–„**ï¼šæ–°å¢æ·˜æ±°è®¡æ•°å™¨å’Œè¯¦ç»†ç»Ÿè®¡

âœ… **æ—¥å¿—æ¸…æ™°**ï¼šæ˜ç¡®æ˜¾ç¤ºå“ªäº›å¸§è¢«æ·˜æ±°åŠåŸå› 

âœ… **ç»“æœå‡†ç¡®**ï¼šåªä¿å­˜é€šè¿‡é˜ˆå€¼çš„å¸§çš„ç»“æœå’Œå›¾åƒ

âœ… **å‘åå…¼å®¹**ï¼šé»˜è®¤é˜ˆå€¼ 10.0pxï¼Œè¡Œä¸ºä¸ä¹‹å‰ç±»ä¼¼
