# 使用流程图

这个文档用ASCII图形展示了系统的使用流程，帮助初学者理解整个过程。

---

## 总体流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     相机倾斜检测系统                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  第1步：准备工作                                                  │
│  ├─ 安装Python依赖 (pip install -r requirements.txt)            │
│  ├─ 安装ROS2依赖 (sudo apt install ros-humble-*)                │
│  └─ 准备标定板 (15×15圆点 + AprilTag)                           │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  第2步：获取相机内参                                              │
│  ├─ 启动相机 (ros2 launch ...)                                  │
│  ├─ 运行提取工具 (python src/camera_rectifier.py)               │
│  └─ 生成 config/camera_info.yaml                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  第3步：选择输入源                                                │
│  ├─ 选项A：实时相机 (--image-topic)                             │
│  └─ 选项B：rosbag文件 (--rosbag)                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  第4步：运行检测                                                  │
│  python robust_tilt_checker_node.py [参数]                       │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│  第5步：查看结果                                                  │
│  ├─ 终端输出 (实时角度和误差)                                    │
│  ├─ 可视化图像 (outputs/*/images/)                              │
│  ├─ JSON结果 (robust_results.json)                              │
│  ├─ CSV表格 (detailed_results.csv)                              │
│  └─ 统计报告 (summary_report.txt)                               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 详细检测流程

```
输入图像 (ROS2话题 或 rosbag)
    │
    ▼
┌──────────────────────────────────────┐
│  1. 图像预处理                        │
│  ├─ 读取图像                          │
│  ├─ 畸变矫正 (使用相机内参)           │
│  └─ 转换为灰度图                      │
└──────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────┐
│  2. 圆点网格检测                      │
│  ├─ Blob检测 (SimpleBlobDetector)    │
│  ├─ 网格匹配 (findCirclesGrid)       │
│  ├─ 角点精化 (cornerSubPix)          │
│  └─ 检测到 N×M 个圆点                │
└──────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────┐
│  3. AprilTag检测                      │
│  ├─ 检测AprilTag标签                  │
│  ├─ 获取AprilTag位姿                  │
│  ├─ 建立坐标系                        │
│  └─ 重新排列圆点 (基于AprilTag方向)   │
└──────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────┐
│  4. 鲁棒PnP求解                       │
│  ├─ 方法1: ITERATIVE                 │
│  ├─ 方法2: SQPNP                     │
│  ├─ 方法3: IPPE                      │
│  ├─ AprilTag位姿约束                 │
│  ├─ 几何一致性检查                    │
│  └─ 选择最优解                        │
└──────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────┐
│  5. 重投影误差计算                    │
│  ├─ 3D点投影回图像                    │
│  ├─ 计算与检测点的距离                │
│  ├─ 平均误差 < 阈值？                 │
│  │   ├─ 是 → 继续                    │
│  │   └─ 否 → 淘汰该帧                │
│  └─ 输出误差统计                      │
└──────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────┐
│  6. 角度计算                          │
│  ├─ 旋转向量 → 旋转矩阵               │
│  ├─ 旋转矩阵 → 欧拉角                 │
│  ├─ Roll (前后仰)                    │
│  ├─ Pitch (平面旋)                   │
│  └─ Yaw (左右歪)                     │
└──────────────────────────────────────┘
    │
    ▼
┌──────────────────────────────────────┐
│  7. 结果输出                          │
│  ├─ 终端打印                          │
│  ├─ 保存可视化图像                    │
│  ├─ 保存JSON/CSV结果                 │
│  ├─ 生成统计报告                      │
│  └─ 发布ROS话题 (可选)               │
└──────────────────────────────────────┘
```

---

## 坐标系关系

```
┌─────────────────────────────────────────────────────────────┐
│                        相机坐标系                            │
│                                                              │
│                          Z (光轴，向前)                      │
│                          ↑                                   │
│                          │                                   │
│                          │                                   │
│                          └────────→ X (向右)                │
│                         ╱                                    │
│                        ╱                                     │
│                       Y (向下)                               │
│                                                              │
└─────────────────────────────────────────────────────────────┘
                          │
                          │ 变换矩阵 [R|t]
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                    标定板坐标系 (基于AprilTag)                │
│                                                              │
│    Y (列方向)                                                │
│    ↑                                                         │
│    │                                                         │
│    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●                     │
│    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●                     │
│    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●                     │
│    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●                     │
│    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●                     │
│    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●                     │
│    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●                     │
│    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●                     │
│    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●                     │
│    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●                     │
│    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●                     │
│    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●                     │
│    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●                     │
│    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●                     │
│    │    ● ● ● ● ● ● ● ● ● ● ● ● ● ● ●                     │
│    │                                                         │
│    O────────────────────────────────→ X (行方向)            │
│  原点 (离AprilTag最近的圆点)                                 │
│                                                              │
│  Z轴：垂直于标定板平面向上                                    │
│                                                              │
│  [AprilTag]  ← AprilTag标签位置                             │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 角度定义图解

### Roll（横滚角）- 前后倾斜

```
侧视图：

相机向前倾 (Roll > 0)          相机水平 (Roll = 0)          相机向后仰 (Roll < 0)
    📷                              📷                              📷
     ╲                              │                              ╱
      ╲                             │                             ╱
       ╲                            │                            ╱
        ▼                           ▼                           ▼
    ═══════                     ═══════                     ═══════
    标定板                       标定板                       标定板
```

### Pitch（俯仰角）- 平面旋转

```
俯视图：

相机顺时针旋转 (Pitch > 0)    相机正对 (Pitch = 0)    相机逆时针旋转 (Pitch < 0)
        📷                          📷                          📷
       ╱                            │                            ╲
      ╱                             │                             ╲
     ╱                              │                              ╲
    ▼                               ▼                               ▼
┌─────────┐                    ┌─────────┐                    ┌─────────┐
│         │                    │         │                    │         │
│ 标定板  │                    │ 标定板  │                    │ 标定板  │
│         │                    │         │                    │         │
└─────────┘                    └─────────┘                    └─────────┘
```

### Yaw（偏航角）- 左右倾斜

```
正视图：

相机向右倾 (Yaw > 0)          相机水平 (Yaw = 0)          相机向左倾 (Yaw < 0)
      📷                            📷                            📷
     ╱                              │                              ╲
    ╱                               │                               ╲
   ╱                                │                                ╲
  ▼                                 ▼                                 ▼
═══════                         ═══════                         ═══════
标定板                           标定板                           标定板
```

---

## 误差淘汰流程

```
检测到一帧图像
    │
    ▼
计算重投影误差
    │
    ▼
┌─────────────────────┐
│ 误差 < 阈值？        │
└─────────────────────┘
    │           │
    │ 是        │ 否
    ▼           ▼
保存结果    淘汰该帧
    │           │
    ▼           ▼
success_count++  rejected_by_error_count++
    │           │
    └───────┬───┘
            │
            ▼
        继续下一帧
```

---

## 输出文件结构

```
outputs/robust_apriltag_results/
│
├── images/                                    # 可视化图像目录
│   ├── frame_000001_robust_result.png        # 第1帧结果图
│   │   ├─ 黄色点：检测到的圆点
│   │   ├─ 绿色框：AprilTag
│   │   ├─ 红/绿/蓝箭头：X/Y/Z坐标轴
│   │   └─ 左上角：详细信息
│   │
│   ├── frame_000002_robust_result.png        # 第2帧结果图
│   └── ...
│
├── robust_results.json                        # JSON格式详细结果
│   ├─ system_info: 系统配置
│   ├─ summary: 统计摘要
│   └─ results: 每一帧的详细数据
│
├── detailed_results.csv                       # CSV格式表格
│   ├─ 可用Excel打开
│   └─ 包含所有帧的数据
│
└── summary_report.txt                         # 统计报告
    ├─ 系统配置
    ├─ 处理统计
    ├─ AprilTag检测统计
    ├─ 角度统计
    ├─ 重投影误差统计
    ├─ PnP方法统计
    └─ 歪斜检测统计
```

---

## 典型使用场景

### 场景1：相机安装质量检查

```
目标：检查相机是否水平安装

步骤：
1. 将标定板水平放置
2. 运行检测程序
3. 查看Roll/Pitch/Yaw角度
4. 判断：
   - 所有角度 < 0.5° → 安装优秀
   - 所有角度 < 1.0° → 安装良好
   - 任何角度 > 2.0° → 需要调整

命令：
python robust_tilt_checker_node.py \
    --image-topic /camera/color/image_raw \
    --camera-yaml config/camera_info.yaml \
    --save-images
```

### 场景2：机器人视觉标定

```
目标：获取相机到标定板的精确变换

步骤：
1. 将标定板固定在机器人工作空间
2. 运行检测程序（启用发布）
3. 订阅ROS话题获取变换参数
4. 用于机器人坐标系转换

命令：
python robust_tilt_checker_node.py \
    --image-topic /camera/color/image_raw \
    --camera-yaml config/camera_info.yaml \
    --publish-results

订阅话题：
ros2 topic echo /tilt_checker/camera_to_board_transform
```

### 场景3：批量数据分析

```
目标：分析大量历史数据

步骤：
1. 准备rosbag文件
2. 运行批量处理（可跳帧）
3. 查看统计报告
4. 分析角度分布和误差

命令：
python robust_tilt_checker_node.py \
    --rosbag /path/to/large.bag \
    --image-topic /camera/color/image_raw \
    --camera-yaml config/camera_info.yaml \
    --skip-frames 10 \
    --max-frames 100 \
    --save-images

查看报告：
cat outputs/robust_apriltag_results/summary_report.txt
```

---

## 故障排除流程图

```
遇到问题
    │
    ▼
┌─────────────────────────────────────┐
│ 问题类型？                           │
└─────────────────────────────────────┘
    │
    ├─ 无法检测到网格
    │   ├─ 检查标定板是否清晰可见
    │   ├─ 改善光照条件
    │   ├─ 调整相机距离和角度
    │   └─ 查看失败帧图像 (*_FAILED.png)
    │
    ├─ AprilTag检测失败
    │   ├─ 确认AprilTag家族 (--tag-family)
    │   ├─ 确认AprilTag尺寸 (--tag-size)
    │   ├─ 确保AprilTag清晰可见
    │   └─ 检查AprilTag是否平整
    │
    ├─ 重投影误差过高
    │   ├─ 重新提取相机内参
    │   ├─ 确认标定板尺寸 (--board-spacing)
    │   ├─ 检查相机标定质量
    │   └─ 调整误差阈值 (--max-error)
    │
    ├─ ROS2相关错误
    │   ├─ 激活ROS2环境 (source /opt/ros/humble/setup.bash)
    │   ├─ 安装ROS2包 (sudo apt install ros-humble-*)
    │   ├─ 检查话题是否存在 (ros2 topic list)
    │   └─ 检查消息类型 (ros2 topic info)
    │
    └─ 其他问题
        ├─ 查看完整README.md
        ├─ 查看错误日志
        ├─ 检查Python依赖
        └─ 联系开发者
```

---

**这个流程图帮助你理解整个系统的工作原理和使用方法。**

**如需更多细节，请查看完整的 README.md 文档。** 🚀
