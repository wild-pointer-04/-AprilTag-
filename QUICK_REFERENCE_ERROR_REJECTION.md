# 重投影误差淘汰功能 - 快速参考

## 一句话总结

**修改后，程序会真正淘汰重投影误差超过 `--max-error` 阈值的图片，不再只是打印警告。**

---

## 快速使用

### 严格模式（推荐用于高精度标定）
```bash
python robust_tilt_checker_node.py \
    --max-error 1.0 \
    --rosbag rosbags/testbag \
    --image-topic /left/color/image_raw \
    --camera-yaml config/camera_info.yaml \
    --rows 15 --cols 15 \
    --save-images
```
**效果**: 只保留误差 ≤ 1.0px 的图片

### 中等模式（推荐用于一般应用）
```bash
python robust_tilt_checker_node.py \
    --max-error 5.0 \
    --rosbag rosbags/testbag \
    --save-images
```
**效果**: 只保留误差 ≤ 5.0px 的图片

### 宽松模式（默认）
```bash
python robust_tilt_checker_node.py \
    --max-error 10.0 \
    --rosbag rosbags/testbag \
    --save-images
```
**效果**: 只保留误差 ≤ 10.0px 的图片

---

## 行为对比

| 场景 | 修改前 | 修改后 |
|------|--------|--------|
| 误差 0.8px | ✅ 保存 | ✅ 保存 |
| 误差 1.5px (阈值1.0) | ✅ 保存 + ⚠️ 警告 | ❌ **淘汰** |
| 误差 5.0px (阈值1.0) | ✅ 保存 + ⚠️ 警告 | ❌ **淘汰** |
| 统计报告 | 不显示淘汰信息 | ✅ 显示淘汰率 |
| 保存的图片 | 所有检测到的 | 只有通过阈值的 |

---

## 日志输出示例

### 通过阈值的帧
```
[frame_000001] ✅ 重投影误差正常: 0.845px
[frame_000001] 📊 统计: 成功=1, 失败=0, 因误差淘汰=0
```

### 被淘汰的帧
```
[frame_000002] ❌ 重投影误差 3.245px 超过阈值 1.0px，淘汰该帧
[frame_000002] 📊 统计: 成功=1, 失败=1, 因误差淘汰=1
```

---

## 统计报告示例

```
处理统计:
  总帧数: 100
  成功检测: 70
  失败检测: 30
    - 因重投影误差超过阈值被淘汰: 25
    - 其他原因失败: 5
  成功率: 70.00%
  淘汰率: 25.00%

重投影误差统计（仅包含通过阈值的帧）:
  误差阈值: 1.0 像素
  通过阈值的帧数: 70
  被淘汰的帧数: 25
  平均误差: 0.654 像素
  最大误差: 0.987 像素
  最小误差: 0.123 像素
```

---

## 阈值设置建议

| 应用场景 | 推荐阈值 | 预期淘汰率 | 说明 |
|---------|---------|-----------|------|
| 高精度相机标定 | 1.0px | 20-40% | 只保留最高质量的图片 |
| 机器人视觉定位 | 3.0px | 10-25% | 平衡质量和数量 |
| 一般视觉应用 | 5.0px | 5-15% | 保留大部分图片 |
| 宽松模式 | 10.0px | 0-5% | 只淘汰明显异常的 |
| 调试模式 | 1000.0px | 0% | 不淘汰任何图片 |

---

## 如何选择合适的阈值？

### 步骤 1: 先用大阈值运行，查看误差分布
```bash
python robust_tilt_checker_node.py --max-error 1000.0 --rosbag test.bag
```

查看 `summary_report.txt` 中的误差统计：
```
重投影误差统计:
  平均误差: 2.345 像素
  最大误差: 15.678 像素
  最小误差: 0.234 像素
```

### 步骤 2: 根据误差分布设置阈值

- 如果平均误差 < 2px → 可以设置阈值为 1.0px
- 如果平均误差 2-5px → 建议设置阈值为 3.0-5.0px
- 如果平均误差 > 5px → 建议设置阈值为 10.0px 或检查系统

### 步骤 3: 重新运行并检查淘汰率
```bash
python robust_tilt_checker_node.py --max-error 3.0 --rosbag test.bag
```

查看淘汰率：
- 淘汰率 < 10%: 阈值可能过松
- 淘汰率 10-30%: ✅ 合适
- 淘汰率 > 50%: 阈值可能过严

---

## 常见问题

### Q1: 为什么我的淘汰率很高（>50%）？

**可能原因**:
1. 阈值设置过严（如 0.5px）
2. 相机标定不准确
3. 标定板质量问题
4. 光照条件不佳

**解决方案**:
- 适当提高阈值（如从 1.0 改为 3.0）
- 重新标定相机
- 改善光照条件

### Q2: 为什么我的淘汰率很低（<5%）？

**可能原因**:
1. 阈值设置过松（如 50.0px）
2. 数据质量本身就很好

**解决方案**:
- 如果需要更高质量，降低阈值
- 如果数据质量已满足需求，保持当前设置

### Q3: 如何查看被淘汰的帧的详细信息？

查看日志输出，搜索 "淘汰该帧"：
```bash
python robust_tilt_checker_node.py ... 2>&1 | grep "淘汰该帧"
```

### Q4: 被淘汰的帧会保存图像吗？

**不会**。被淘汰的帧：
- ❌ 不保存图像
- ❌ 不保存到 JSON 结果
- ❌ 不保存到 CSV 结果
- ✅ 只在日志中记录

---

## 验证修改是否生效

运行测试脚本：
```bash
python test_error_rejection.py
```

预期看到所有测试用例都显示 ✅

---

## 相关文件

- `robust_tilt_checker_node.py` - 主程序（已修改）
- `ERROR_REJECTION_CHANGES.md` - 详细修改说明
- `test_error_rejection.py` - 测试脚本
- `outputs/robust_apriltag_results/summary_report.txt` - 统计报告

---

## 技术细节

修改的核心代码（第 402-420 行）：
```python
# 检查重投影误差并淘汰超过阈值的帧
if robust_error > self.max_reprojection_error:
    self.rejected_by_error_count += 1
    self.failure_count += 1
    self.get_logger().error(
        f'❌ 重投影误差 {robust_error:.3f}px 超过阈值 {self.max_reprojection_error}px，淘汰该帧'
    )
    return None  # 直接返回，不保存任何结果
```

**关键点**: `return None` 会导致：
1. 不执行后续的角度计算
2. 不构建结果字典
3. 不保存到 `all_results` 列表
4. 不保存图像
5. 不发布 ROS 消息

---

## 总结

✅ **修改完成**: 程序现在会真正淘汰高误差图片

✅ **使用简单**: 只需设置 `--max-error` 参数

✅ **统计清晰**: 报告中显示淘汰率和原因

✅ **质量保证**: 只保留高质量的标定数据
