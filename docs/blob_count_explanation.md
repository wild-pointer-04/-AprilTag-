# 为什么 Blob 检测到的圆点数量 > 期望值？

## 问题现象

你发现几乎所有图片的 blob 检测候选圆点数量都**大于期望的 225 个点**（15×15）。

## 原因分析

### 1. **Blob 检测是"候选检测"，不是"网格匹配"**

**Blob 检测**（`SimpleBlobDetector`）的作用：
- 找到图像中**所有符合圆形特征的区域**
- **不关心**这些圆点是否属于网格
- **不关心**网格的行列数

**结果**：
- 检测到的 blob 可能包括：
  - ✅ 板子上的圆点（目标）
  - ❌ 背景中的圆形物体（噪声）
  - ❌ 图像中的其他圆形特征
  - ❌ 反光、阴影形成的圆形区域
  - ❌ 板子边缘的圆形装饰

### 2. **检测参数可能偏宽松**

当前参数设置：
```python
minArea = 10        # 最小面积较小
minCircularity = 0.5  # 圆形度要求中等
minInertiaRatio = 0.15  # 惯性比要求较低
```

**影响**：
- 较小的 `minArea` 可能检测到小噪声点
- 较低的 `minCircularity` 可能检测到不太圆的物体
- 较低的 `minInertiaRatio` 可能检测到椭圆形状

### 3. **图像中的其他圆形特征**

可能检测到的非目标圆点：
- **背景中的圆形物体**：灯、按钮、装饰等
- **反光形成的圆形区域**：板子表面的反光
- **阴影形成的圆形区域**：光照产生的阴影
- **图像压缩伪影**：JPEG 压缩产生的圆形伪影
- **板子边缘的圆形特征**：框架上的圆形装饰

### 4. **网格匹配会过滤掉多余的 blob**

**关键**：`findCirclesGrid` 会从所有 blob 中**选择**符合网格结构的点

**过程**：
1. Blob 检测：找到 300 个候选圆点
2. 网格匹配：从中选择 225 个点，组成 15×15 网格
3. 多余的 75 个点被过滤掉

**所以**：
- Blob 数量 > 225 是**正常的**
- 只要网格匹配成功（`ok=True`），就说明找到了正确的 225 个点
- 多余的 blob 会被网格匹配算法自动过滤

## 可视化说明

现在代码会在结果图上显示：
- **绿色点**：所有 blob 检测到的候选圆点（包括噪声）
- **黄色点**：网格匹配成功的点（实际使用的点）

**观察**：
- 如果绿色点明显多于黄色点，说明检测到了很多噪声
- 如果绿色点和黄色点基本重合，说明检测质量很好

## 如何减少多余的 Blob？

### 方法1：收紧检测参数

```python
# 在 build_blob_detector() 或 build_adaptive_blob_detector() 中
p.minArea = 15  # 提高最小面积（过滤小噪声）
p.minCircularity = 0.6  # 提高圆形度要求
p.minInertiaRatio = 0.2  # 提高惯性比要求
```

### 方法2：使用 ROI（感兴趣区域）

```python
# 只检测板子所在的区域
roi = gray[y1:y2, x1:x2]
blob_keypoints = detector.detect(roi)
```

### 方法3：后处理过滤

```python
# 根据位置过滤（如果知道板子大致位置）
filtered_keypoints = []
for kp in keypoints:
    x, y = kp.pt
    if is_in_board_region(x, y):  # 自定义函数
        filtered_keypoints.append(kp)
```

## 总结

### Blob 数量 > 期望值的原因：

1. ✅ **正常现象**：Blob 检测是候选检测，不关心网格结构
2. ✅ **网格匹配会过滤**：`findCirclesGrid` 会从所有 blob 中选择正确的点
3. ✅ **检测参数可能偏宽松**：检测到了噪声和其他圆形特征
4. ✅ **图像中的其他圆形物体**：背景、反光、阴影等

### 判断标准：

- **如果网格匹配成功**（`ok=True`）：说明找到了正确的点，多余的 blob 不影响结果
- **如果网格匹配失败**（`ok=False`）：可能需要收紧检测参数或检查图像质量

### 可视化帮助：

现在代码会用**绿色点**标出所有 blob 检测到的点，你可以：
- 观察哪些是真正的圆点（黄色点覆盖的绿色点）
- 观察哪些是噪声（只有绿色点，没有黄色点）
- 根据观察结果调整检测参数

