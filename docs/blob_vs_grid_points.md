# 绿色点 vs 黄色点：对不上的原因与调整方法

## 可视化说明

- **绿色点**：所有 blob 检测到的候选圆点（`SimpleBlobDetector` 的输出）
- **黄色点**：网格匹配成功的点（`findCirclesGrid` 的输出，实际用于 PnP）

## 为什么绿色点和黄色点对不上？

### 情况1：绿色点 > 黄色点（常见）

**现象**：图像中有很多绿色点，但只有部分变成黄色点

**原因**：
1. **Blob 检测到了噪声**：
   - 背景中的圆形物体
   - 反光、阴影形成的圆形区域
   - 图像压缩伪影
   - 板子边缘的圆形装饰

2. **网格匹配过滤**：
   - `findCirclesGrid` 只选择符合网格结构的点
   - 不符合网格几何约束的点被过滤掉
   - 这是**正常现象**，说明网格匹配在工作

**判断标准**：
- ✅ **正常**：如果黄色点数量 = `rows×cols`（如 225），说明匹配成功
- ⚠️ **需要调整**：如果黄色点数量 < `rows×cols`，说明匹配不完整

### 情况2：绿色点和黄色点位置偏差

**现象**：绿色点和黄色点位置不完全重合，有偏移

**原因**：
1. **Blob 检测精度**：
   - Blob 检测给出的是圆点的**粗略位置**
   - 精度可能不够高（像素级）

2. **网格匹配精化**：
   - `findCirclesGrid` 会进行**亚像素精化**
   - 调整点的位置以符合网格结构
   - 黄色点是精化后的位置

3. **亚像素优化**：
   - 后续的 `refine()` 会进一步优化
   - 黄色点位置更准确

**判断标准**：
- ✅ **正常**：如果偏移 < 3-5 像素，说明检测质量好
- ⚠️ **需要调整**：如果偏移 > 10 像素，说明 blob 检测精度不够

### 情况3：某些圆点只有绿色点，没有黄色点

**现象**：板子上的某些圆点只有绿色点，没有对应的黄色点

**原因**：
1. **网格匹配失败**：
   - 这些点不符合网格的几何约束
   - 可能是边缘点，网格结构不完整
   - 或者透视畸变导致位置偏差太大

2. **行列数不匹配**：
   - 实际网格可能是 10×10，但代码尝试 15×15
   - 多余的圆点无法匹配到网格位置

**判断标准**：
- ⚠️ **需要调整**：如果板子中心的圆点也没有黄色点，说明网格匹配有问题
- ✅ **可接受**：如果只是边缘点没有黄色点，可能是正常的（边缘点缺失）

## 如何根据观察结果调整检测参数？

### 步骤1：观察绿色点的分布

**观察项**：
1. **绿色点是否覆盖所有圆点**？
   - 如果某些圆点没有绿色点 → blob 检测参数太严格
   - 如果绿色点太多（明显超过圆点数量）→ blob 检测参数太宽松

2. **绿色点的位置是否准确**？
   - 如果绿色点明显偏离圆点中心 → 需要调整检测参数或使用更好的精化方法

### 步骤2：观察黄色点的分布

**观察项**：
1. **黄色点数量是否正确**？
   - 应该是 `rows×cols`（如 225）
   - 如果少于期望值 → 网格匹配不完整

2. **黄色点是否覆盖所有圆点**？
   - 如果中心圆点也没有黄色点 → 网格匹配失败
   - 如果只是边缘点没有 → 可能是正常的

### 步骤3：根据观察结果调整参数

#### 情况A：绿色点太少（某些圆点没有绿色点）

**问题**：Blob 检测参数太严格，漏掉了真正的圆点

**调整方法**：
```python
# 在 build_blob_detector() 或 build_adaptive_blob_detector() 中
p.minArea = 5  # 降低最小面积（从 10 降到 5）
p.minCircularity = 0.3  # 降低圆形度要求（从 0.5 降到 0.3）
p.minInertiaRatio = 0.10  # 降低惯性比要求（从 0.15 降到 0.10）
```

#### 情况B：绿色点太多（明显超过圆点数量）

**问题**：Blob 检测参数太宽松，检测到了很多噪声

**调整方法**：
```python
p.minArea = 15  # 提高最小面积（从 10 提高到 15）
p.minCircularity = 0.6  # 提高圆形度要求（从 0.5 提高到 0.6）
p.minInertiaRatio = 0.20  # 提高惯性比要求（从 0.15 提高到 0.20）
p.maxArea = 50000  # 降低最大面积（从 100000 降到 50000）
```

#### 情况C：绿色点和黄色点位置偏差大（>10像素）

**问题**：Blob 检测精度不够，或者需要更好的精化

**调整方法**：
1. **使用改进的精化方法**：
   ```python
   # 在 refine_improved() 中使用加权质心
   corners = refine_improved(gray, centers, use_weighted_centroid=True)
   ```

2. **调整 blob 检测参数**：
   ```python
   # 提高检测精度（可能需要更严格的参数）
   p.minCircularity = 0.7  # 更严格的圆形度
   ```

#### 情况D：黄色点数量不足（< rows×cols）

**问题**：网格匹配不完整，可能是：
- Blob 检测到的点不够
- 网格结构不完整
- 透视畸变过大

**调整方法**：
1. **先解决情况A**（确保所有圆点都有绿色点）
2. **检查网格尺寸**：确认 `rows` 和 `cols` 是否正确
3. **尝试不同的对称性**：对称 vs 非对称网格

## 实际调整示例

### 示例1：检测到很多噪声（绿色点太多）

```python
# 在 src/utils.py 的 build_blob_detector() 中
def build_blob_detector():
    p = cv2.SimpleBlobDetector_Params()
    p.filterByArea = True
    p.minArea = 15  # 提高（过滤小噪声）
    p.maxArea = 50000  # 降低（过滤大物体）
    p.filterByCircularity = True
    p.minCircularity = 0.6  # 提高（更严格的圆形度）
    p.maxCircularity = 1.0
    p.filterByInertia = True
    p.minInertiaRatio = 0.20  # 提高（过滤椭圆）
    p.filterByConvexity = False
    return cv2.SimpleBlobDetector_create(p)
```

### 示例2：漏掉了一些圆点（绿色点太少）

```python
# 在 src/detect_grid_improved.py 的 build_adaptive_blob_detector() 中
def build_adaptive_blob_detector(gray, base_params=None):
    # ...
    if mean_intensity < 100:
        min_area = 3  # 降低（从 5 降到 3）
        min_circularity = 0.3  # 降低（从 0.4 降到 0.3）
    else:
        min_area = 8  # 降低（从 10 降到 8）
        min_circularity = 0.4  # 降低（从 0.5 降到 0.4）
    # ...
```

## 判断标准总结

### ✅ 正常情况

1. **绿色点数量**：略多于 `rows×cols`（如 250-300 vs 225）
2. **黄色点数量**：等于 `rows×cols`（225）
3. **位置偏差**：绿色点和黄色点偏移 < 5 像素
4. **覆盖情况**：所有板子上的圆点都有绿色点，中心区域都有黄色点

### ⚠️ 需要调整的情况

1. **绿色点太少**：某些圆点没有绿色点 → 降低检测参数
2. **绿色点太多**：明显超过圆点数量（> 1.5倍）→ 提高检测参数
3. **黄色点不足**：黄色点数量 < `rows×cols` → 检查网格匹配
4. **位置偏差大**：绿色点和黄色点偏移 > 10 像素 → 提高检测精度

## 调试建议

### 1. 统计信息

观察输出中的诊断信息：
```
[DEBUG] Blob检测: 300 个候选圆点, 期望 225 个点
[DEBUG]   匹配结果: ok=True, 成功匹配 225/225 个点
```

### 2. 可视化对比

对比两张图片：
- `board_result.png`：只看黄色点（网格匹配结果）
- `board_result_with_blobs.png`：看绿色点和黄色点（完整信息）

### 3. 逐步调整

1. **先调整 blob 检测参数**（影响绿色点）
2. **观察网格匹配结果**（影响黄色点）
3. **如果网格匹配失败，再调整参数**
4. **重复直到满意**

## 总结

- **绿色点 ≠ 黄色点**是正常的，因为网格匹配会过滤噪声
- **判断标准**：黄色点数量应该 = `rows×cols`，位置偏差应该 < 5 像素
- **调整方法**：根据观察结果，逐步调整 blob 检测参数
- **关键**：确保所有真正的圆点都有绿色点，然后让网格匹配选择正确的点

