# 相机标定和重投影误差分析工具使用说明

## 功能概述

`calibration_and_reprojection.py` 工具提供完整的相机标定和误差分析流程：

1. **畸变矫正**: 使用 YAML 中的内参对 data 目录中的所有图像进行畸变矫正
2. **相机标定**: 使用矫正后的图像进行相机标定
3. **重投影误差计算**: 计算所有图像的重投影误差
4. **误差分布可视化**: 绘制重投影误差分布散点图

## 使用方法

### 基本用法

```bash
# 使用默认参数
python src/calibration_and_reprojection.py

# 指定参数
python src/calibration_and_reprojection.py \
    --data-dir data \
    --undistorted-dir data_undistorted \
    --camera-yaml config/camera_info.yaml \
    --rows 15 \
    --cols 15 \
    --spacing 10.0 \
    --output outputs/reprojection_errors.png
```

### 参数说明

- `--data-dir`: 输入图像目录（默认: `data`）
- `--undistorted-dir`: 矫正后的图像保存目录（默认: `data_undistorted`）
- `--camera-yaml`: 相机内参 YAML 文件路径（默认: `config/camera_info.yaml`）
- `--rows`: 圆点行数（默认: 15）
- `--cols`: 圆点列数（默认: 15）
- `--spacing`: 圆点间距，单位 mm（默认: 10.0）
- `--output`: 误差分布图保存路径（默认: `outputs/reprojection_errors.png`）

## 工作流程

### 步骤 1: 畸变矫正

1. 从 YAML 文件加载相机内参（K 和 dist）
2. 如果图像尺寸与 YAML 中记录的不匹配，自动缩放内参
3. 对每张图像使用 `cv2.undistort()` 进行畸变矫正
4. 保存矫正后的图像到 `data_undistorted` 目录

**输出**:
- 矫正后的图像文件（`*_undistorted.png`）

### 步骤 2: 相机标定

1. 在矫正后的图像上检测圆点网格（15×15）
2. 使用检测到的 2D 点（图像坐标）和对应的 3D 点（世界坐标）进行标定
3. 调用 `cv2.calibrateCamera()` 计算新的内参和畸变系数

**输出**:
- 标定得到的内参矩阵 K
- 标定得到的畸变系数 dist
- 每张图像的旋转向量 rvecs 和平移向量 tvecs

### 步骤 3: 重投影误差计算

对每张图像计算重投影误差：

```python
# 将 3D 点投影到 2D 图像平面
imgpoints2, _ = cv2.projectPoints(
    objpoints[i], rvecs[i], tvecs[i], 
    camera_matrix, dist_coeffs
)

# 计算误差
error = cv2.norm(imgpoints[i], imgpoints2, cv2.NORM_L2) / len(imgpoints2)
```

**输出**:
- 每张图像的平均误差
- 所有点的误差列表
- 总平均误差

### 步骤 4: 误差分布可视化

生成两个图表：

1. **每张图像的平均误差散点图**:
   - X 轴: 图像编号
   - Y 轴: 平均重投影误差（像素）
   - 显示每张图像的平均误差和总体平均误差线

2. **所有点的误差分布直方图**:
   - X 轴: 重投影误差（像素）
   - Y 轴: 点的数量
   - 显示误差的分布情况

**输出**:
- 误差分布图（`outputs/reprojection_errors.png`）

## 输出文件

### 矫正后的图像

保存在 `data_undistorted/` 目录：
```
data_undistorted/
├── board_undistorted.png
├── board1_undistorted.png
├── board2_undistorted.png
└── ...
```

### 误差分布图

保存在 `outputs/reprojection_errors.png`：
- 上图：每张图像的平均误差散点图
- 下图：所有点的误差分布直方图

## 重投影误差说明

### 什么是重投影误差？

重投影误差是衡量相机标定精度的指标：

1. **3D 点投影**: 使用标定得到的内参和位姿，将 3D 点投影到 2D 图像平面
2. **误差计算**: 计算投影点与检测到的 2D 点之间的距离
3. **平均误差**: 所有点的误差的平均值

### 误差范围

- **< 0.5 像素**: 优秀，标定精度很高
- **0.5 - 1.0 像素**: 良好，标定精度较高
- **1.0 - 2.0 像素**: 一般，可以接受
- **> 2.0 像素**: 较差，可能需要重新标定

### 影响因素

1. **图像质量**: 模糊、噪声会影响检测精度
2. **标定板质量**: 圆点是否清晰、完整
3. **图像数量**: 通常需要 10-20 张不同角度的图像
4. **图像分布**: 应该覆盖整个视野，不同角度和距离

## 示例输出

```
============================================================
步骤 1: 畸变矫正
============================================================
加载的内参矩阵 K:
[[690.48   0.   645.51]
 [  0.   690.13  358.94]
 [  0.     0.     1.  ]]
畸变系数 D: [ 0.0087 -0.0458  0.0005  0.0003  0.0308]

找到 12 张图像

处理 [1/12]: board.png
  图像尺寸: 1920 x 1080
  [INFO] 图像尺寸不匹配，缩放内参...
  ✅ 已保存: data_undistorted/board_undistorted.png
...

✅ 完成！共矫正 12 张图像

============================================================
步骤 2: 相机标定
============================================================
3D 对象点: 225 个点，间距 10.0mm

检测圆点网格...

处理 [1/12]: board_undistorted.png
  ✅ 成功检测到 225 个点
...

✅ 成功检测 12 张图像，开始标定...

执行相机标定（图像尺寸: 1920 x 1080）...

✅ 标定完成！
标定得到的内参矩阵 K:
[[1035.73    0.     968.27]
 [   0.    1035.19  538.42]
 [   0.       0.      1.  ]]
标定得到的畸变系数 D: [ 0.0012 -0.0023  0.0001  0.0001  0.0015]

============================================================
步骤 3: 计算重投影误差
============================================================
图像 1: 平均误差 = 0.2341 像素, 点数 = 225
图像 2: 平均误差 = 0.1987 像素, 点数 = 225
...

✅ 总平均重投影误差: 0.2156 像素
   误差范围: 0.1234 ~ 0.3456 像素

============================================================
步骤 4: 绘制重投影误差分布图
============================================================
✅ 已保存误差分布图: outputs/reprojection_errors.png

统计信息:
  图像数量: 12
  总点数: 2700
  每张图像平均误差: 0.2156 ± 0.0456 像素
  所有点平均误差: 0.2156 ± 0.1234 像素
  最小误差: 0.0123 像素
  最大误差: 0.7890 像素
  中位数误差: 0.1987 像素
```

## 注意事项

1. **图像数量**: 至少需要 3 张图像进行标定，建议 10-20 张
2. **图像质量**: 确保图像清晰，圆点完整可见
3. **网格检测**: 如果某张图像检测失败，会被跳过，不影响其他图像
4. **内参缩放**: 如果图像尺寸与 YAML 中记录的不匹配，会自动缩放内参
5. **误差分析**: 如果误差较大，可能需要：
   - 增加标定图像数量
   - 改善图像质量
   - 重新提取相机内参

## 故障排除

### 问题 1: 无法检测到圆点网格

**原因**: 图像质量差、圆点不清晰、网格尺寸不匹配

**解决**:
- 检查图像是否清晰
- 确认 `--rows` 和 `--cols` 参数正确
- 检查圆点是否完整可见

### 问题 2: 标定失败

**原因**: 成功检测的图像数量不足（< 3 张）

**解决**:
- 增加图像数量
- 改善图像质量
- 检查圆点检测参数

### 问题 3: 重投影误差较大

**原因**: 标定精度不够、图像质量差、标定板质量差

**解决**:
- 增加标定图像数量（10-20 张）
- 确保图像覆盖整个视野
- 使用高质量的标定板
- 改善光照条件

## 相关文件

- `src/calibration_and_reprojection.py`: 主程序
- `src/utils.py`: 内参加载和缩放函数
- `src/detect_grid_improved.py`: 圆点检测函数
- `src/estimate_tilt.py`: 3D 点构建函数
- `config/camera_info.yaml`: 相机内参配置文件

