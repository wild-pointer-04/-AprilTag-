# 倾斜角计算逻辑分析与相机安装验证问题

## 当前代码的倾斜角计算逻辑

### 1. 位姿求解流程

```python
# 步骤1: 定义板子坐标系（世界坐标系）
build_obj_points() 
# → 板子平面 Z=0, X/Y 在板子平面内

# 步骤2: PnP求解
solvePnP(objp, corners, K, dist)
# → 得到 rvec, tvec
# → rvec: 板子坐标系 → 相机坐标系的旋转

# 步骤3: 转换为欧拉角
rvec_to_euler_xyz(rvec)
# → Roll, Pitch, Yaw
```

### 2. 坐标系统定义

**板子坐标系（世界坐标系）**：
- X轴：沿列方向（向右）
- Y轴：沿行方向（向下）
- Z轴：垂直于板子平面（向上）

**相机坐标系**：
- X轴：图像右方向
- Y轴：图像下方向
- Z轴：光轴方向（向前，指向场景）

### 3. 欧拉角含义

当前代码的 `rvec_to_euler_xyz` 计算的是：
- **Roll (X轴旋转)**：绕X轴旋转，板子左右倾斜
- **Pitch (Y轴旋转)**：绕Y轴旋转，板子前后倾斜
- **Yaw (Z轴旋转)**：绕Z轴旋转，板子平面旋转

**关键问题**：这些角度反映的是**板子相对于相机的姿态**，而不是**相机相对于水平面的姿态**。

## 问题分析

### 问题1：Yaw ≈ 180° 的原因

Yaw接近180度通常意味着：
- 板子的X轴方向与相机X轴方向大致相反
- 这可能是：
  - 板子旋转了180度
  - 或者板子坐标系定义与相机坐标系定义不一致
  - 或者在图像中板子是"倒置"或"反向"的

### 问题2：当前逻辑不适合验证相机安装

**你的需求**：验证相机安装是否存在歪斜

**当前代码的问题**：
1. ❌ 假设板子是水平的（Z=0平面），但实际上板子可能本身就有倾斜
2. ❌ 计算的是"板子相对于相机"的角度，而不是"相机相对于水平面"的角度
3. ❌ 如果板子不水平，计算出的角度包含板子倾斜和相机倾斜的混合

### 问题3：坐标系定义不一致

板子坐标系的定义：
- 如果板子是垂直放置（立在墙上），Z轴应该是水平的
- 如果板子是水平放置（平放在桌上），Z轴应该是垂直的
- 代码假设板子是水平的，但实际可能不是

## 正确的相机安装验证逻辑

### 方案1：假设板子水平放置（推荐）

如果板子是**水平放置**的（平放在桌上），那么：

1. **板子坐标系**应该是：
   - X/Y轴在水平面内
   - Z轴垂直向上（或向下）

2. **相机倾斜角度**应该是：
   - Roll = 相机绕光轴（Z轴）的左右倾斜
   - Pitch = 相机绕水平轴（X轴）的前后倾斜
   - 但需要从"板子→相机"的旋转中提取

3. **修正方法**：
   ```python
   # 如果板子是水平的，Z轴应该垂直向上
   # 相机坐标系Z轴向前，Y轴向下
   # 需要转换角度定义
   ```

### 方案2：使用已知水平的参考面

如果板子本身可能倾斜，应该：
1. 使用**水平仪**或**已知水平的参考面**
2. 或者使用**重力传感器**（如果相机有IMU）
3. 不能仅凭板子验证相机倾斜

### 方案3：相对测量（两次测量）

1. 第一次：测量板子A的姿态（作为参考）
2. 第二次：测量板子B的姿态
3. 对比两次结果，如果板子都是水平的，差异就是相机倾斜

## 代码问题与改进建议

### 当前问题

1. **Yaw ≈ 180°**：
   - 可能是坐标系定义问题
   - 或者板子确实旋转了180度
   - 需要根据实际板子方向调整

2. **角度定义不明确**：
   - Roll/Pitch/Yaw 的具体含义需要明确
   - 对于相机安装验证，应该是什么角度？

3. **缺少参考基准**：
   - 假设板子是水平的，但没有验证
   - 如果板子本身倾斜，结果就错了

### 改进建议

#### 1. 明确角度定义

```python
def rvec_to_camera_tilt(rvec):
    """
    计算相机相对于水平面的倾斜角
    
    假设：
    - 板子是水平放置的（Z轴垂直向上）
    - 相机坐标系：X右、Y下、Z前
    
    返回：
    - roll: 相机绕Z轴的左右倾斜（度）
    - pitch: 相机绕X轴的前后倾斜（度）
    - yaw: 相机绕Y轴的旋转（度，通常不重要）
    """
    R, _ = cv2.Rodrigues(rvec)
    
    # 板子坐标系 → 相机坐标系
    # 板子Z轴（垂直向上）在相机坐标系中的方向
    z_board_in_camera = R @ np.array([0, 0, 1])
    
    # 计算倾斜角
    # Pitch: 前后倾斜 = atan2(z_board_in_camera[2], z_board_in_camera[1])
    # Roll: 左右倾斜 = atan2(z_board_in_camera[0], z_board_in_camera[2])
    
    # 注意：需要根据实际坐标系定义调整
    pass
```

#### 2. 添加坐标系验证

```python
def verify_board_orientation(corners, rows, cols):
    """
    验证板子是否水平放置
    
    通过分析检测到的点，判断：
    - 板子是否大致水平
    - 是否有明显倾斜
    """
    # 分析点的分布
    # 如果板子水平，点在图像中的分布应该更均匀
    pass
```

#### 3. 角度归一化

```python
def normalize_angles(roll, pitch, yaw):
    """
    将角度归一化到 [-180, 180] 或 [0, 360]
    
    Yaw接近180度时，可能需要：
    - 转换为 [-180, 180] 范围
    - 或者判断是否是180度旋转（翻面）
    """
    # 处理Yaw的180度情况
    if abs(yaw) > 170:
        yaw = yaw - 180 if yaw > 0 else yaw + 180
        # 可能需要调整Roll和Pitch的符号
    return roll, pitch, yaw
```

## 总结

### 当前代码的问题

1. ❌ **角度计算的是板子姿态，不是相机姿态**
2. ❌ **假设板子是水平的，但没有验证**
3. ❌ **Yaw ≈ 180° 表示坐标系定义可能有问题**
4. ❌ **不适合直接用于验证相机安装倾斜**

### 验证相机安装的正确方法

1. ✅ **确保板子水平放置**（使用水平仪）
2. ✅ **明确坐标系定义**（板子坐标系 vs 相机坐标系）
3. ✅ **计算相机相对于水平面的角度**（而不是板子相对于相机的角度）
4. ✅ **多次测量取平均**（提高精度）
5. ✅ **考虑使用已知的相机内参**（而不是默认值）

### 建议

如果要验证相机安装，应该：
1. **先验证板子是否水平**（使用水平仪）
2. **明确板子坐标系定义**
3. **从板子→相机的旋转中提取相机倾斜角**
4. **或者使用两次测量对比**（板子水平和倾斜时）

