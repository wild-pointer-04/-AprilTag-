# 测试说明 - 你遇到的问题和解决方案

## 你遇到的问题

你运行了：
```bash
python3 test_camera_capture_service.py --single
```

然后看到：
```
[INFO] 等待拍照服务...
[INFO] 服务尚未就绪，继续等待...
```

## 问题原因

**拍照服务节点还没有启动！**

测试脚本是**客户端**，它需要调用**服务端**。但是服务端（`camera_capture_service_node.py`）还没有运行。

这就像：
- 你（测试脚本）想打电话给朋友（服务节点）
- 但朋友的手机还没开机（服务还没启动）
- 所以你一直在等待...

## 解决方案

### 最简单的方法：使用一键测试脚本

```bash
# 1. 先启动相机（新终端）
ros2 launch orbbec_camera gemini_330_series.launch.py

# 2. 运行测试脚本（另一个终端）
./simple_test.sh
```

这个脚本会：
✅ 自动检查相机
✅ 自动启动服务
✅ 自动运行测试
✅ 显示结果
✅ 自动清理

### 手动方法（理解原理）

你需要**同时运行两个程序**：

#### 终端 1：启动相机
```bash
source ~/ros2_ws/install/setup.bash
ros2 launch orbbec_camera gemini_330_series.launch.py
```

#### 终端 2：启动服务（这一步你漏掉了！）
```bash
source ~/ros2_ws/install/setup.bash
python3 src/camera_capture_service_node.py
```

等待看到：
```
📷 相机拍照服务节点已启动
✅ 已接收到图像，服务就绪
🎯 服务就绪，等待拍照请求...
```

#### 终端 3：运行测试
```bash
source ~/ros2_ws/install/setup.bash
python3 test_camera_capture_service.py --single
```

现在应该成功了！

## 快速测试命令对比

### ❌ 错误的做法（你之前的做法）
```bash
# 只运行测试，没有启动服务
python3 test_camera_capture_service.py --single
# 结果：一直等待...
```

### ✅ 正确的做法 1（最简单）
```bash
# 使用一键测试脚本
./simple_test.sh
# 结果：自动完成所有步骤
```

### ✅ 正确的做法 2（手动）
```bash
# 终端1: 启动相机
ros2 launch orbbec_camera gemini_330_series.launch.py

# 终端2: 启动服务
python3 src/camera_capture_service_node.py

# 终端3: 运行测试
python3 test_camera_capture_service.py --single
```

### ✅ 正确的做法 3（命令行）
```bash
# 如果服务已经在运行，直接用命令行测试
ros2 service call /camera_capture std_srvs/srv/Trigger
```

## 推荐的测试脚本

我为你创建了几个测试脚本，按难度排序：

### 1. simple_test.sh（最推荐）
```bash
./simple_test.sh
```
- ✅ 最简单，有向导
- ✅ 一步一步引导
- ✅ 自动检查和启动
- ✅ 适合第一次使用

### 2. run_test.sh
```bash
./run_test.sh
```
- ✅ 快速测试
- ✅ 自动运行多个测试
- ✅ 显示结果

### 3. quick_test.sh
```bash
./quick_test.sh
```
- ✅ 完整的测试流程
- ✅ 可以保持服务运行

### 4. 手动测试（理解原理）
```bash
# 终端1
ros2 launch orbbec_camera gemini_330_series.launch.py

# 终端2
python3 src/camera_capture_service_node.py

# 终端3
python3 test_camera_capture_service.py --single
```

## 测试流程图

```
开始
  ↓
相机是否启动？
  ↓ 否 → 启动相机 → ros2 launch orbbec_camera ...
  ↓ 是
服务是否启动？
  ↓ 否 → 启动服务 → python3 src/camera_capture_service_node.py
  ↓ 是
运行测试
  ↓
python3 test_camera_capture_service.py --single
  ↓
查看结果
  ↓
ls captured_images/
  ↓
完成
```

## 验证成功的标志

### 1. 服务端（终端2）显示：
```
📸 已拍好第1张照片
   保存路径: captured_images/capture_0001_20231121_143025_123.png
   图像尺寸: 640x480
```

### 2. 测试端（终端3）显示：
```
✅ 拍照成功: 已拍好第1张照片
```

### 3. 文件系统：
```bash
$ ls captured_images/
capture_0001_20231121_143025_123.png
```

## 现在就开始测试

### 方法 1：最简单（推荐）

```bash
# 终端1：启动相机
ros2 launch orbbec_camera gemini_330_series.launch.py

# 终端2：运行测试脚本
./simple_test.sh
```

### 方法 2：一键测试

```bash
# 确保相机已启动，然后：
./run_test.sh
```

### 方法 3：命令行快速测试

```bash
# 终端1：相机
ros2 launch orbbec_camera gemini_330_series.launch.py

# 终端2：服务
python3 src/camera_capture_service_node.py

# 终端3：测试
ros2 service call /camera_capture std_srvs/srv/Trigger
```

## 常见问题

### Q1: 为什么需要三个终端？

A: 因为有三个独立的程序需要同时运行：
1. 相机驱动（发布图像）
2. 拍照服务（接收图像，提供服务）
3. 测试程序（调用服务）

### Q2: 可以只用一个终端吗？

A: 可以！使用测试脚本（`simple_test.sh`），它会在后台启动服务。

### Q3: 如何知道服务已经启动？

A: 运行 `ros2 service list | grep capture`，如果看到 `/camera_capture` 就说明服务已启动。

### Q4: 测试失败怎么办？

A: 按顺序检查：
1. 相机是否启动？`ros2 topic list | grep image`
2. 服务是否启动？`ros2 service list | grep capture`
3. 查看服务日志，看是否有错误

## 下一步

测试成功后：

1. **与机械臂集成**
   - 在机械臂程序中调用 `/camera_capture` 服务
   - 参考 `docs/camera_capture_service_usage.md`

2. **调整参数**
   - 修改保存目录
   - 更改图像格式

3. **添加功能**
   - AprilTag 检测
   - 图像质量检查

## 获取帮助

- 简单测试：`./simple_test.sh`
- 详细指南：`cat HOW_TO_TEST.md`
- 完整文档：`cat TEST_GUIDE.md`
- 安装配置：`cat CAMERA_CAPTURE_SETUP.md`
